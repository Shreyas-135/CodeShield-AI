'use server';
/**
 * @fileOverview Explains a detected vulnerability in plain English.
 *
 * - explainVulnerability - A function that explains the vulnerability.
 * - ExplainVulnerabilityInput - The input type for the explainVulnerability function.
 * - ExplainVulnerabilityOutput - The return type for the explainVulnerability function.
 */

import {ai} from '@/ai/genkit';
import {z} from 'genkit';

const ExplainVulnerabilityInputSchema = z.object({
  codeSnippet: z.string().describe('The code snippet containing the vulnerability.'),
  vulnerabilityDescription: z.string().describe('A description of the vulnerability.'),
  expertiseLevel: z.enum(["Beginner", "Intermediate", "Expert"]).describe("The expertise level of the target audience for the explanation.")
});
export type ExplainVulnerabilityInput = z.infer<typeof ExplainVulnerabilityInputSchema>;

const ExplainVulnerabilityOutputSchema = z.object({
  plainEnglishExplanation: z.string().describe('A plain English explanation of the vulnerability.'),
  securityImpactSummary: z.string().describe('A summary of the security impact of the vulnerability.'),
  locationInCode: z.string().describe('The location of the vulnerability in the code.'),
});
export type ExplainVulnerabilityOutput = z.infer<typeof ExplainVulnerabilityOutputSchema>;

export async function explainVulnerability(input: ExplainVulnerabilityInput): Promise<ExplainVulnerabilityOutput> {
  return explainVulnerabilityFlow(input);
}

const prompt = ai.definePrompt({
  name: 'explainVulnerabilityPrompt',
  input: {schema: ExplainVulnerabilityInputSchema},
  output: {schema: ExplainVulnerabilityOutputSchema},
  prompt: `You are a security expert explaining code vulnerabilities to different audiences.

  Your task is to explain the vulnerability based on the user's selected expertise level: {{expertiseLevel}}.

  - **Beginner**: Explain in the simplest possible terms. Use analogies. Assume no technical knowledge. Focus on "why it's bad."
  - **Intermediate**: Explain for a developer. Be clear and direct. Mention common bad practices and why the code is vulnerable.
  - **Expert**: Explain for a security engineer. Be precise and technical. Mention specific CWEs (Common Weakness Enumeration) if applicable and discuss the attack vectors.

  Given the following code snippet and vulnerability description, provide a plain English explanation of the vulnerability, a summary of its security impact, and the location of the vulnerability in the code, all tailored to the **{{expertiseLevel}}** level.

  Vulnerability Description: {{vulnerabilityDescription}}

  Code Snippet:
  '''
  {{codeSnippet}}
  '''

  Plain English Explanation: (Explain why itâ€™s a risk, tailored to the {{expertiseLevel}} level.)
  Security Impact Summary: (Provide a concise summary of the potential security impact, tailored to the {{expertiseLevel}} level.)
  Location in Code: (Show the exact location of the vulnerability in the code snippet.)`,
});

const explainVulnerabilityFlow = ai.defineFlow(
  {
    name: 'explainVulnerabilityFlow',
    inputSchema: ExplainVulnerabilityInputSchema,
    outputSchema: ExplainVulnerabilityOutputSchema,
  },
  async input => {
    const {output} = await prompt(input);
    return output!;
  }
);
