"use client";

import { useEffect, useState } from 'react';
import { AlertTriangle, Lightbulb, Wrench, ChevronDown, FileCode, Sparkles } from 'lucide-react';
import { Card } from '@/components/ui/card';
import { Collapsible, CollapsibleContent, CollapsibleTrigger } from '@/components/ui/collapsible';
import { Button } from '@/components/ui/button';
import { Skeleton } from '@/components/ui/skeleton';
import { useToast } from "@/hooks/use-toast"
import type { UIVulnerability } from '@/ai/flows/detect-vulnerabilities';

import { explainVulnerability, type ExplainVulnerabilityOutput } from '@/ai/flows/explain-vulnerability';
import { suggestFix, type SuggestFixOutput } from '@/ai/flows/suggest-fix';
import { Badge } from '../ui/badge';
import { Alert, AlertDescription, AlertTitle } from '../ui/alert';

interface VulnerabilityCardProps {
  vulnerability: UIVulnerability;
}

export function VulnerabilityCard({ vulnerability }: VulnerabilityCardProps) {
  const [explanation, setExplanation] = useState<ExplainVulnerabilityOutput | null>(null);
  const [fix, setFix] = useState<SuggestFixOutput | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [isOpen, setIsOpen] = useState(false);
  const { toast } = useToast();

  useEffect(() => {
    if (!isOpen) return;

    const getDetails = async () => {
      // Don't refetch if we already have the data
      if (explanation || fix) return;

      setIsLoading(true);
      try {
        const [explanationResult, fixResult] = await Promise.all([
          explainVulnerability({ codeSnippet: vulnerability.codeSnippet, vulnerabilityDescription: vulnerability.description }),
          suggestFix({ codeSnippet: vulnerability.codeSnippet, vulnerabilityDescription: vulnerability.description })
        ]);
        setExplanation(explanationResult);
        setFix(fixResult);
      } catch (error) {
        console.error('Failed to get vulnerability details:', error);
        toast({
            variant: "destructive",
            title: "Analysis Error",
            description: `Could not analyze vulnerability: ${vulnerability.type}`,
        })
      } finally {
        setIsLoading(false);
      }
    };

    getDetails();
  }, [vulnerability, toast, isOpen, explanation, fix]);

  const handleApplyFix = () => {
    if (!fix) return;
    toast({
        title: "Live Fix Applied (Simulation)",
        description: (
            <div className="mt-2 w-full">
                <p className="text-sm">The vulnerable code has been replaced with the AI-suggested fix.</p>
                <div className="mt-4 space-y-4">
                     <div>
                        <h5 className="font-semibold text-destructive">Original Code:</h5>
                        <pre className="mt-1 bg-destructive/10 p-2 rounded-md font-code text-xs overflow-x-auto text-destructive">
                            <code>{vulnerability.codeSnippet}</code>
                        </pre>
                    </div>
                     <div>
                        <h5 className="font-semibold text-green-500">Corrected Code:</h5>
                        <pre className="mt-1 bg-green-950 p-2 rounded-md font-code text-xs overflow-x-auto text-green-400">
                            <code>{fix.suggestedFix}</code>
                        </pre>
                    </div>
                </div>
            </div>
        ),
        duration: 8000,
    })
  }

  return (
    <Card className="overflow-hidden">
      <Collapsible open={isOpen} onOpenChange={setIsOpen}>
        <CollapsibleTrigger asChild>
          <div className="flex items-center justify-between p-4 cursor-pointer hover:bg-muted/50">
            <div className="flex items-center gap-4">
              <AlertTriangle className="w-6 h-6 text-destructive" />
              <div>
                <h3 className="font-semibold text-lg">{vulnerability.type}</h3>
                <p className="text-sm text-muted-foreground">{vulnerability.file}:{vulnerability.line}</p>
              </div>
            </div>
            <Button variant="ghost" size="sm" className="w-9 p-0">
              <ChevronDown className={`h-4 w-4 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
              <span className="sr-only">Toggle details</span>
            </Button>
          </div>
        </CollapsibleTrigger>
        <CollapsibleContent>
          <div className="border-t p-6 space-y-6">
            {isLoading ? (
              <div className="space-y-4">
                <Skeleton className="h-8 w-1/3" />
                <Skeleton className="h-20 w-full" />
                <Skeleton className="h-8 w-1/3" />
                <Skeleton className="h-32 w-full" />
              </div>
            ) : (
              <>
                <div>
                  <h4 className="flex items-center gap-2 font-semibold mb-2"><FileCode className="w-5 h-5" />Vulnerable Code</h4>
                   <pre className="bg-muted p-4 rounded-md font-code text-sm overflow-x-auto">
                        <code>{vulnerability.codeSnippet}</code>
                    </pre>
                </div>
                {explanation && (
                  <div>
                    <h4 className="flex items-center gap-2 font-semibold mb-2"><Lightbulb className="w-5 h-5" />Explanation</h4>
                    <div className="space-y-2 text-sm">
                        <p className="text-muted-foreground">{explanation.plainEnglishExplanation}</p>
                        <p className="text-muted-foreground"><strong className="text-foreground">Security Impact:</strong> {explanation.securityImpactSummary}</p>
                    </div>
                  </div>
                )}
                {fix && (
                  <div>
                    <div className="flex justify-between items-center mb-2">
                        <h4 className="flex items-center gap-2 font-semibold"><Wrench className="w-5 h-5" />Suggested Fix</h4>
                        <Button size="sm" onClick={handleApplyFix}><Sparkles className="w-4 h-4 mr-2" />Apply Fix</Button>
                    </div>

                    <p className="text-sm text-muted-foreground mb-2">{fix.explanation}</p>
                    <pre className="bg-muted p-4 rounded-md font-code text-sm overflow-x-auto">
                        <code>{fix.suggestedFix}</code>
                    </pre>
                  </div>
                )}
              </>
            )}
          </div>
        </CollapsibleContent>
      </Collapsible>
    </Card>
  );
}
